#!/bin/bash
# AWS Profile selector with fzf and SSO login

# Check if AWS CLI is available
if ! command -v aws >/dev/null 2>&1; then
    echo "âŒ AWS CLI not found. Please install it first."
    exit 1
fi

# Check if fzf is available
if ! command -v fzf >/dev/null 2>&1; then
    echo "âŒ fzf not found. Please install it first."
    exit 1
fi

# Check if AWS config file exists
if [ ! -f ~/.aws/config ]; then
    echo "âŒ AWS config file not found at ~/.aws/config"
    exit 1
fi

echo "ğŸ” Loading profile information from ~/.aws/config..."

# Parse AWS config file and format for fzf
selection=$(awk '
    /^\[profile / {
        if (profile != "") {
            printf "%-20s %-15s %s\n", profile, account_id, region
        }
        profile = $2
        gsub(/\]/, "", profile)
        account_id = "unknown"
        region = "unknown"
    }
    /^sso_account_id/ && profile != "" { account_id = $3 }
    /^region/ && profile != "" { region = $3 }
    END {
        if (profile != "") {
            printf "%-20s %-15s %s\n", profile, account_id, region
        }
    }
' ~/.aws/config | fzf \
    --prompt="Select AWS Profile: " \
    --height=40% \
    --border \
    --header="Profile              Account ID      Region")

if [ -z "$selection" ]; then
    echo "âŒ No profile selected."
    exit 1
fi

# Extract just the profile name (first column)
selected_profile=$(echo "$selection" | awk '{print $1}')

echo "ğŸ”„ Setting AWS profile to: $selected_profile"

# Set the AWS profile
export AWS_PROFILE="$selected_profile"

# Test if the session is valid by trying to get caller identity
echo "ğŸ” Testing AWS session..."

if aws sts get-caller-identity >/dev/null 2>&1; then
    echo "âœ… AWS session is valid!"
    echo "ğŸ‘¤ Current identity:"
    aws sts get-caller-identity --output table
    
    # Show current profile info
    echo ""
    echo "ğŸ“‹ Profile: $AWS_PROFILE"
    region=$(aws configure get region --profile "$AWS_PROFILE" 2>/dev/null)
    if [ -n "$region" ]; then
        echo "ğŸŒ Region: $region"
    fi
else
    echo "âŒ AWS session invalid or expired. Running SSO login..."
    
    # Run SSO login for the selected profile
    aws sso login --profile "$selected_profile"
    
    # Test again after login
    if aws sts get-caller-identity >/dev/null 2>&1; then
        echo "âœ… AWS SSO login successful!"
        echo "ğŸ‘¤ Current identity:"
        aws sts get-caller-identity --output table
    else
        echo "âŒ AWS SSO login failed. Please check your configuration."
        exit 1
    fi
fi

echo "ğŸ”„ Refreshing shell prompt..."