# Platform-Specific Configuration Fixes

This document tracks macOS/Linux compatibility issues in the dotfiles repository and their fixes.

## Summary

Analysis performed on 2025-11-18 to identify hardcoded platform-specific paths and configurations that prevent proper operation across macOS and NixOS (Steam Deck).

## Issues Found

### ✅ Already Fixed
- **Alacritty** (`config/alacritty/alacritty.toml:28`) - Hardcoded macOS PATH removed

### ✅ No Issues
- **Starship** - Clean, cross-platform configuration
- **Tmux** - Already handles clipboard across all platforms (lines 41-49)
- **Nvim** - Core config is platform-agnostic
- **Fish** - Mostly cross-platform with proper checks

---

## Issues Requiring Fixes

### HIGH PRIORITY - Will Cause Errors

#### 1. Zsh: FZF Paths (`.zshrc:37-38`)

**Problem:**
```zsh
source /usr/share/fzf/key-bindings.zsh
source /usr/share/fzf/completion.zsh
```
- Hardcoded Linux paths
- Will error on macOS (Homebrew uses `/opt/homebrew/opt/fzf/shell/`)

**Fix:**
```zsh
# Platform-agnostic FZF integration
if [[ -f /usr/share/fzf/key-bindings.zsh ]]; then
    # Linux (system package manager)
    source /usr/share/fzf/key-bindings.zsh
    source /usr/share/fzf/completion.zsh
elif [[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]]; then
    # macOS (Homebrew)
    source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
    source /opt/homebrew/opt/fzf/shell/completion.zsh
fi
```

#### 2. Zsh: Kubectl Completion (`.zshrc:60`)

**Problem:**
```zsh
source <(kubectl completion zsh)
```
- Fails with error if kubectl not installed
- No conditional check

**Fix:**
```zsh
# Only load kubectl completion if kubectl is available
command -v kubectl >/dev/null 2>&1 && source <(kubectl completion zsh)
```

#### 3. Zsh: NVM Path (`.zshrc:61`)

**Problem:**
```zsh
source /usr/share/nvm/init-nvm.sh
```
- Hardcoded Linux path
- macOS Homebrew uses `/opt/homebrew/opt/nvm/nvm.sh`

**Fix:**
```zsh
# Platform-agnostic NVM integration
[[ -s /usr/share/nvm/init-nvm.sh ]] && source /usr/share/nvm/init-nvm.sh  # Linux
[[ -s /opt/homebrew/opt/nvm/nvm.sh ]] && source /opt/homebrew/opt/nvm/nvm.sh  # macOS
```

#### 4. Zsh: Missing Include Files (`.zshrc:31-35`)

**Problem:**
```zsh
include ~/dotfiles/.aliasrc
include ~/dotfiles/.initrc
include ~/dotfiles/.pathrc
include ~/dotfiles/.personalrc
include ~/dotfiles/.secretrc
```
- These files don't exist in the repository
- Will silently fail due to the `include` function check on line 27-29

**Status:** Not breaking due to the conditional check, but should be cleaned up or files should be created.

---

### MEDIUM PRIORITY - Won't Break But Should Fix

#### 5. Zsh: macOS Plugin (`.zshrc:15`)

**Problem:**
```zsh
plugins=(
    ...
    osx
    ...
)
```
- The `osx` plugin only works on macOS
- Won't break on Linux, but adds noise

**Fix:**
```zsh
plugins=(
    git
    z
    aws
    docker
    node
    npm
    # osx  # macOS only - remove or conditionally load
    pip
    python
    redis-cli
    ssh-agent
    sudo
    yarn
    ripgrep
)
```

Or conditionally load:
```zsh
if [[ "$OSTYPE" == "darwin"* ]]; then
    plugins+=(osx)
fi
```

---

### LOW PRIORITY - Cosmetic Issues

#### 6. Nvim: Lua LSP Config (`.luarc.json`)

**Problem:**
- File contains hardcoded macOS user paths: `/Users/sebastianuskh/...`
- Contains hardcoded Homebrew path: `/opt/homebrew/Cellar/neovim/0.9.4/...`
- Used by Lua Language Server for editor completion

**Fix:**
```bash
# Simply delete the file - it will be regenerated by LSP
rm config/nvim/lua/.luarc.json

# Add to .gitignore
echo "config/nvim/lua/.luarc.json" >> .gitignore
```

---

## Safe Platform-Specific Code (No Changes Needed)

These configurations already handle cross-platform properly:

### Tmux Clipboard (tmux.conf:41-49)
```tmux
# Already handles all platforms with conditional checks
if -b 'command -v xsel > /dev/null 2>&1' 'bind y run -b ...'
if -b 'command -v xclip > /dev/null 2>&1' 'bind y run -b ...'
if -b '[ "$XDG_SESSION_TYPE" = "wayland" ] && command -v wl-copy > /dev/null 2>&1' 'bind y run -b ...'
if -b 'command -v pbcopy > /dev/null 2>&1' 'bind y run -b ...'
```

### Fish ASDF Integration (config.fish:18-22)
```fish
if type -q brew
    source $(brew --prefix asdf)/libexec/asdf.fish
else
    source /opt/asdf-vm/asdf.fish
end
```

### Fish Google Cloud SDK (config.fish:51)
```fish
if [ -f '/opt/homebrew/share/google-cloud-sdk/path.fish.inc' ]; . '/opt/homebrew/share/google-cloud-sdk/path.fish.inc'; end
```

### Zsh iTerm2 Integration (`.zshrc:44`)
```zsh
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"
```

---

## Implementation Checklist

- [x] Fix: Alacritty hardcoded PATH (COMPLETED)
- [ ] Fix: Zsh FZF paths
- [ ] Fix: Zsh kubectl completion
- [ ] Fix: Zsh NVM path
- [ ] Consider: Remove/conditional load osx plugin
- [ ] Optional: Delete .luarc.json and add to .gitignore
- [ ] Optional: Create or remove references to missing .{alias,init,path,personal,secret}rc files

---

## Testing Plan

After applying fixes:

### On NixOS (Steam Deck)
```bash
# Test Alacritty
alacritty -e echo "test"

# Test Zsh
zsh -l -c "echo 'zsh loaded'"

# Test Tmux
tmux new-session -d -s test && tmux kill-session -t test

# Test Fish (if used)
fish -c "echo 'fish loaded'"

# Test Neovim
nvim --headless +checkhealth +qa
```

### On macOS
```bash
# Same tests as above
# Verify Homebrew paths are working
# Check FZF keybindings work (Ctrl+T, Ctrl+R)
# Verify kubectl completion if kubectl installed
```

---

## Related Files

- `config/alacritty/alacritty.toml` - Terminal emulator
- `.zshrc` - Zsh shell configuration
- `config/fish/config.fish` - Fish shell configuration
- `config/tmux/tmux.conf` - Tmux multiplexer
- `config/nvim/` - Neovim editor
- `config/starship/starship.toml` - Shell prompt

---

## Notes

- The repository uses a two-layer configuration system:
  - Traditional dotfiles (macOS/Linux) via `setup.sh`
  - NixOS declarative configuration via `nix/` directory
- Most issues stem from hardcoded absolute paths without conditional checks
- Best practice: Always check for file/command existence before sourcing/running
- Alternative approach: Use platform-specific config files with imports (like Alacritty could do)

---

## References

- Original issue: Alacritty couldn't boot due to hardcoded macOS PATH in `[env]` section
- Root cause: `/opt/homebrew/bin` doesn't exist on NixOS, breaking command execution
- Analysis date: 2025-11-18
